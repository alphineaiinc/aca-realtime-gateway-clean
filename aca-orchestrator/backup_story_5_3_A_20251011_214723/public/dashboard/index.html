<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ACA Confidence Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background-color: #f8f9fa; }
    #brainStatus {
      font-weight: bold;
      padding: 10px 16px;
      border-radius: 12px;
      box-shadow: 0 0 8px rgba(255, 215, 0, 0.3);
      display: inline-block;
      min-width: 220px;
      transition: all 0.4s ease;
    }
    #brainStatus.active {
      color: #000;
      background: radial-gradient(circle at center, #ffd700 0%, #ffcc33 60%, #f8f9fa 100%);
      box-shadow: 0 0 12px rgba(255, 215, 0, 0.8);
    }
    #brainStatus.inactive {
      color: #666;
      background: #e0e0e0;
      box-shadow: none;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container my-5">
    <h2 class="text-center mb-4">🤖 ACA Confidence Dashboard</h2>

    <!-- 🧠 Brain Diagnostics Panel -->
    <div class="mb-4 text-center">
      <div id="brainStatus" class="inactive">Checking Brain status…</div>
      <div id="brainMeta" class="small text-muted mt-2"></div>
    </div>

    <div class="d-flex align-items-center gap-3 mb-3 flex-wrap">
      <label>Level:</label>
      <select id="levelFilter" class="form-select w-auto">
        <option>ALL</option><option>INFO</option><option>WARN</option><option>ERROR</option>
      </select>
      <label>Confidence Range:</label>
      <input id="minConf" type="number" min="0" max="1" step="0.1" value="0" class="form-control w-auto">
      <span>to</span>
      <input id="maxConf" type="number" min="0" max="1" step="0.1" value="1" class="form-control w-auto">
      <button id="applyBtn" class="btn btn-primary btn-sm">Apply</button>
    </div>

    <canvas id="confidenceChart" height="100"></canvas>
    <hr />
    <h5>Recent Log Entries</h5>
    <table class="table table-sm table-striped">
      <thead><tr><th>Timestamp</th><th>Level</th><th>Message</th></tr></thead>
      <tbody id="logTable"></tbody>
    </table>
  </div>

  <script>
    let chart;
    let lastRenderArgs = { level: "ALL", min: 0, max: 1 };

    // ------------------------------
    // Fetch brain diagnostics status
    // ------------------------------
    async function refreshBrainStatus() {
      const el = document.getElementById("brainStatus");
      const meta = document.getElementById("brainMeta");
      try {
        const res = await fetch("/dashboard/brain-status", { cache: "no-store" });
        const data = await res.json();
        if (!res.ok || !data.ok) {
          el.className = "inactive";
          el.textContent = "❌ Brain offline";
          meta.textContent = "";
          return;
        }
        if (data.brain_enabled) {
          el.className = "active";
          el.textContent = "🧠 Brain Active";
          meta.textContent =
            `Uptime: ${data.uptime_sec}s | Memory: ${data.memory_mb} MB | Queries: ${data.query_count} | Host: ${data.hostname}`;
        } else {
          el.className = "inactive";
          el.textContent = "⚫ Brain Inactive";
          meta.textContent = "";
        }
      } catch (e) {
        el.className = "inactive";
        el.textContent = "⚠️ Unable to reach Brain";
        meta.textContent = "";
      }
    }

    // ------------------------------
    // Fetch adaptive response logs
    // ------------------------------
    async function fetchEntries() {
      const res = await fetch("/dashboard/data", { cache: "no-store" });
      return res.ok ? (await res.json()).entries || [] : [];
    }

    function extractConfidence(msg) {
      const m = msg.match(/confidence[:=]\s*(\d+(\.\d+)?)/i);
      return m ? parseFloat(m[1]) : null;
    }

    function applyFilters(entries, level, minC, maxC) {
      return entries.filter(e => {
        if (level !== "ALL" && e.level !== level) return false;
        const c = extractConfidence(e.message);
        return c === null || (c >= minC && c <= maxC);
      });
    }

    function renderChart(confidences) {
      const ctx = document.getElementById("confidenceChart");
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: confidences.map((_, i) => i + 1),
          datasets: [{
            label: "Response Confidence",
            data: confidences,
            borderColor: "rgba(54,162,235,0.9)",
            tension: 0.2,
            pointRadius: 0
          }]
        },
        options: {
          animation: false,
          scales: { y: { min: 0, max: 1, title: { display: true, text: "Confidence" } } }
        }
      });
    }

    function renderTable(entries) {
      const tbody = document.getElementById("logTable");
      tbody.innerHTML = "";
      entries.slice(-50).reverse().forEach(e => {
        tbody.insertAdjacentHTML("beforeend",
          `<tr><td>${e.timestamp}</td><td>${e.level}</td><td>${e.message}</td></tr>`);
      });
    }

    async function loadData() {
      const level = lastRenderArgs.level;
      const minC = lastRenderArgs.min;
      const maxC = lastRenderArgs.max;

      const entries = await fetchEntries();
      const filtered = applyFilters(entries, level, minC, maxC);
      const confidences = filtered.map(e => extractConfidence(e.message))
                                 .filter(v => v !== null);

      renderChart(confidences);
      renderTable(filtered);
    }

    // Hook filter UI
    function bindUi() {
      const levelSel = document.getElementById("levelFilter");
      const minInp = document.getElementById("minConf");
      const maxInp = document.getElementById("maxConf");
      const applyBtn = document.getElementById("applyBtn");

      applyBtn.addEventListener("click", () => {
        lastRenderArgs = {
          level: levelSel.value,
          min: parseFloat(minInp.value) || 0,
          max: parseFloat(maxInp.value) || 1
        };
        loadData();
      });
    }

    // ------------------------------
    // Initialize dashboard
    // ------------------------------
    window.addEventListener("DOMContentLoaded", () => {
      bindUi();
      loadData();
      refreshBrainStatus();
      setInterval(loadData, 5000);
      setInterval(refreshBrainStatus, 10000);
    });
  </script>
</body>
</html>
