<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Billing & Invoices ‚Äì Alphine AI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind CSS (Option 2 ‚Äì modern, stylish UI) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- HTMX (included for future partial updates, not critical yet) -->
  <script src="https://unpkg.com/htmx.org@1.9.12"></script>

  <script>
    // Tailwind config tweak for Alphine brand
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            alphine: {
              bg: "#020617",
              card: "#020617",
              cardAlt: "#020617",
              accent: "#38bdf8",
              accentSoft: "#0ea5e9",
            },
          },
        },
      },
    };
  </script>
</head>
<body class="min-h-screen bg-slate-950 text-slate-100 antialiased">
  <!-- Page wrapper -->
  <div class="min-h-screen flex flex-col">
    <!-- Top nav / header -->
    <header class="border-b border-slate-800 bg-slate-950/80 backdrop-blur">
      <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between gap-4">
        <div>
          <p class="text-xs uppercase tracking-[0.2em] text-slate-500">Alphine AI ¬∑ Partner Portal</p>
          <h1 class="text-xl md:text-2xl font-semibold text-slate-50">
            Billing &amp; Invoices
          </h1>
          <p class="text-xs md:text-sm text-slate-400 mt-1">
            View your subscription, usage, and download invoices securely.
          </p>
        </div>
        <div class="flex flex-col items-end gap-1">
          <span class="inline-flex items-center rounded-full bg-slate-900 border border-slate-700 px-3 py-1 text-xs text-slate-300">
            <span class="w-2 h-2 rounded-full bg-emerald-400 mr-2"></span>
            Billing system: <span class="ml-1 font-medium text-slate-100">Online</span>
          </span>
          <span id="billing-plan-pill" class="text-xs text-slate-500">
            Plan: <span class="font-medium text-slate-200" id="billing-plan-name">‚Äì</span>
          </span>
        </div>
      </div>
    </header>

    <!-- Token + main content -->
    <main class="flex-1">
      <div class="max-w-6xl mx-auto px-4 py-6 space-y-6">
        <!-- Token bar -->
        <section class="rounded-2xl border border-slate-800 bg-slate-900/70 p-4 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div class="space-y-1">
            <div class="flex items-center gap-2">
              <span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-sky-500/10 text-sky-400 text-xs">
                üîê
              </span>
              <h2 class="text-sm font-medium text-slate-100">
                Secure Access Token
              </h2>
            </div>
            <p class="text-xs text-slate-400">
              Paste your partner JWT token once. We store it only in this browser‚Äôs local storage and send it
              on each billing API request.
            </p>
            <p id="token-status" class="text-xs text-amber-400 hidden">
              No token found ‚Äì please paste a valid partner JWT to load billing data.
            </p>
          </div>
          <div class="flex flex-col sm:flex-row gap-2 w-full md:w-auto">
            <input
              id="token-input"
              type="password"
              placeholder="Paste JWT token here"
              class="flex-1 rounded-xl border border-slate-700 bg-slate-900/80 px-3 py-2 text-xs text-slate-100 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-sky-500/70"
            />
            <button
              id="save-token-btn"
              class="inline-flex items-center justify-center rounded-xl bg-sky-500 px-4 py-2 text-xs font-medium text-slate-950 shadow-sm hover:bg-sky-400 focus:outline-none focus:ring-2 focus:ring-sky-500/70"
            >
              Save token
            </button>
          </div>
        </section>

        <!-- Summary cards -->
        <section class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <!-- Card: Current Plan -->
          <div class="rounded-2xl border border-slate-800 bg-gradient-to-b from-slate-900/80 to-slate-950 p-4 flex flex-col justify-between">
            <div class="flex items-center justify-between gap-2">
              <div>
                <p class="text-xs uppercase tracking-wide text-slate-500">Current Plan</p>
                <p class="mt-1 text-sm font-semibold text-slate-50" id="summary-plan-name">‚Äì</p>
              </div>
              <span id="summary-plan-status-pill" class="inline-flex items-center rounded-full bg-slate-900 border border-slate-700 px-3 py-1 text-[11px] text-slate-300">
                <span class="w-1.5 h-1.5 rounded-full bg-slate-500 mr-1.5"></span>
                <span id="summary-plan-status">‚Äì</span>
              </span>
            </div>
            <p class="mt-3 text-[11px] text-slate-400" id="summary-plan-desc">
              Your active subscription will appear here once billing is configured.
            </p>
          </div>

          <!-- Card: This Month -->
          <div class="rounded-2xl border border-slate-800 bg-slate-950 p-4 flex flex-col justify-between">
            <div class="flex items-center justify-between gap-2">
              <div>
                <p class="text-xs uppercase tracking-wide text-slate-500">This Month (Usage)</p>
                <p class="mt-1 text-sm font-semibold text-slate-50" id="summary-month-amount">
                  ‚Äì
                </p>
              </div>
              <div class="text-right">
                <p class="text-[11px] text-slate-500">Minutes</p>
                <p class="text-xs font-medium text-slate-100" id="summary-month-minutes">‚Äì</p>
                <p class="mt-1 text-[11px] text-slate-500">Calls</p>
                <p class="text-xs font-medium text-slate-100" id="summary-month-calls">‚Äì</p>
              </div>
            </div>
            <p class="mt-3 text-[11px] text-slate-400" id="summary-month-period">
              Current billing period will be shown here.
            </p>
          </div>

          <!-- Card: Next Invoice -->
          <div class="rounded-2xl border border-slate-800 bg-slate-950 p-4 flex flex-col justify-between">
            <div class="flex items-center justify-between gap-2">
              <div>
                <p class="text-xs uppercase tracking-wide text-slate-500">Next Invoice</p>
                <p class="mt-1 text-sm font-semibold text-slate-50" id="summary-next-amount">
                  ‚Äì
                </p>
              </div>
              <div class="text-right">
                <p class="text-[11px] text-slate-500">Due</p>
                <p class="text-xs font-medium text-slate-100" id="summary-next-date">‚Äì</p>
                <p class="mt-1 text-[11px] text-slate-500">Outstanding</p>
                <p class="text-xs font-medium" id="summary-outstanding">
                  ‚Äì
                </p>
              </div>
            </div>
            <p class="mt-3 text-[11px] text-slate-400" id="summary-next-note">
              You‚Äôll see your upcoming invoice date and amount here.
            </p>
          </div>
        </section>

        <!-- Invoices + Actions -->
        <section class="space-y-3">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <div>
              <h2 class="text-sm font-medium text-slate-100">Invoice History</h2>
              <p class="text-xs text-slate-400 mt-1">
                Download invoices for your records, accounting, or tax filing.
              </p>
            </div>
            <div class="flex flex-wrap gap-2">
              <button
                id="refresh-billing-btn"
                class="inline-flex items-center rounded-xl border border-slate-700 bg-slate-900/80 px-3 py-1.5 text-xs text-slate-200 hover:bg-slate-800/80"
              >
                ‚ü≥ Refresh
              </button>
              <button
                id="download-all-btn"
                class="inline-flex items-center rounded-xl bg-sky-500 px-3 py-1.5 text-xs font-medium text-slate-950 hover:bg-sky-400"
              >
                ‚¨á Download all invoices (ZIP)
              </button>
            </div>
          </div>

          <!-- Table wrapper -->
          <div class="overflow-hidden rounded-2xl border border-slate-800 bg-slate-950/80">
            <div class="overflow-x-auto">
              <table class="min-w-full text-xs text-left">
                <thead class="bg-slate-900/70 border-b border-slate-800">
                  <tr>
                    <th class="px-4 py-3 font-medium text-slate-400">Date</th>
                    <th class="px-4 py-3 font-medium text-slate-400">Invoice</th>
                    <th class="px-4 py-3 font-medium text-slate-400">Period</th>
                    <th class="px-4 py-3 font-medium text-slate-400 text-right">Amount</th>
                    <th class="px-4 py-3 font-medium text-slate-400">Status</th>
                    <th class="px-4 py-3 font-medium text-slate-400 text-right">Actions</th>
                  </tr>
                </thead>
                <tbody id="invoice-tbody" class="divide-y divide-slate-800">
                  <tr id="invoice-empty-row">
                    <td colspan="6" class="px-4 py-6 text-center text-slate-500 text-xs">
                      No invoices found yet. Once billing is active, your invoices will appear here.
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <p id="invoice-error" class="text-[11px] text-rose-400 hidden">
            Unable to load invoices. Please check your token or try again later.
          </p>
        </section>
      </div>
    </main>

    <!-- Footer -->
    <footer class="border-t border-slate-900 bg-slate-950/90">
      <div class="max-w-6xl mx-auto px-4 py-3 flex flex-col sm:flex-row items-center justify-between gap-2">
        <p class="text-[11px] text-slate-500">
          ¬© <span id="footer-year"></span> Alphine AI ¬∑ Automated Call Attender
        </p>
        <p class="text-[11px] text-slate-500">
          Billing powered by Stripe ¬∑ Partner-safe export of invoices.
        </p>
      </div>
    </footer>
  </div>

  <!-- Billing JS (inline for now, can be moved to billing.js if you prefer) -->
  <script>
    const API_BASE = "/api/billing";
    const TOKEN_STORAGE_KEY = "aca_partner_jwt";

    function getToken() {
      return localStorage.getItem(TOKEN_STORAGE_KEY) || "";
    }

    function setToken(token) {
      if (token && token.trim().length > 0) {
        localStorage.setItem(TOKEN_STORAGE_KEY, token.trim());
      }
      updateTokenUiState();
    }

    function updateTokenUiState() {
      const token = getToken();
      const statusEl = document.getElementById("token-status");
      const inputEl = document.getElementById("token-input");
      if (!statusEl || !inputEl) return;

      if (!token) {
        statusEl.classList.remove("hidden");
        inputEl.value = "";
      } else {
        statusEl.classList.add("hidden");
        inputEl.value = "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢";
      }
    }

    function formatCurrency(amount, currency = "USD") {
      if (amount == null || isNaN(amount)) return "‚Äì";
      try {
        return new Intl.NumberFormat("en-US", {
          style: "currency",
          currency,
        }).format(amount);
      } catch {
        return amount.toFixed(2) + " " + currency;
      }
    }

    function formatDate(iso) {
      if (!iso) return "‚Äì";
      const d = new Date(iso);
      if (isNaN(d.getTime())) return "‚Äì";
      return d.toLocaleDateString("en-CA", {
        year: "numeric",
        month: "short",
        day: "2-digit",
      });
    }

    function setBadgeStatus(status) {
      if (!status) return { label: "Unknown", classes: "bg-slate-900 border border-slate-700 text-slate-300" };
      const normalized = String(status).toLowerCase();
      if (normalized === "paid") {
        return {
          label: "Paid",
          classes: "bg-emerald-500/10 border border-emerald-500/60 text-emerald-300",
        };
      }
      if (normalized === "open" || normalized === "due" || normalized === "pending") {
        return {
          label: "Pending",
          classes: "bg-amber-500/10 border border-amber-500/60 text-amber-200",
        };
      }
      if (normalized === "uncollectible" || normalized === "failed" || normalized === "overdue") {
        return {
          label: "Overdue",
          classes: "bg-rose-500/10 border border-rose-500/60 text-rose-200",
        };
      }
      return {
        label: status,
        classes: "bg-slate-900 border border-slate-700 text-slate-300",
      };
    }

    async function fetchJson(endpoint) {
      const token = getToken();
      if (!token) {
        throw new Error("Missing token");
      }
      const res = await fetch(endpoint, {
        headers: {
          "Authorization": "Bearer " + token,
          "Accept": "application/json",
        },
      });
      if (!res.ok) {
        const body = await res.text().catch(() => "");
        const err = new Error("Request failed: " + res.status);
        err.status = res.status;
        err.body = body;
        throw err;
      }
      return res.json();
    }

    async function loadSummary() {
      try {
        const data = await fetchJson(API_BASE + "/summary");
        // Expected shape (you may adjust mapping to your actual JSON):
        // {
        //   plan_name, plan_status, plan_description,
        //   this_month_amount, this_month_minutes, this_month_calls, this_month_period,
        //   next_invoice_amount, next_invoice_date,
        //   outstanding_amount, outstanding_currency
        // }

        const planName = data.plan_name || "No active plan";
        const planStatus = data.plan_status || "inactive";
        const planDesc = data.plan_description || "Your plan details will appear once billing is configured.";

        document.getElementById("billing-plan-name").textContent = planName;
        document.getElementById("summary-plan-name").textContent = planName;
        document.getElementById("summary-plan-desc").textContent = planDesc;

        const planStatusEl = document.getElementById("summary-plan-status");
        const planStatusPill = document.getElementById("summary-plan-status-pill");
        if (planStatusEl && planStatusPill) {
          const badge = setBadgeStatus(planStatus);
          planStatusEl.textContent = badge.label;
          planStatusPill.className =
            "inline-flex items-center rounded-full px-3 py-1 text-[11px] " + badge.classes;
          // Add tiny dot
          const existingDot = planStatusPill.querySelector("span.dot");
          if (!existingDot) {
            const dot = document.createElement("span");
            dot.className = "dot w-1.5 h-1.5 rounded-full bg-current mr-1.5";
            planStatusPill.insertBefore(dot, planStatusPill.firstChild);
          }
        }

        document.getElementById("summary-month-amount").textContent = formatCurrency(
          data.this_month_amount || 0,
          data.currency || "USD"
        );
        document.getElementById("summary-month-minutes").textContent =
          (data.this_month_minutes ?? "‚Äì") + " min";
        document.getElementById("summary-month-calls").textContent =
          (data.this_month_calls ?? "‚Äì") + " calls";
        document.getElementById("summary-month-period").textContent =
          data.this_month_period || "Current billing period.";

        document.getElementById("summary-next-amount").textContent = formatCurrency(
          data.next_invoice_amount || 0,
          data.currency || "USD"
        );
        document.getElementById("summary-next-date").textContent = formatDate(
          data.next_invoice_date
        );
        document.getElementById("summary-outstanding").textContent = formatCurrency(
          data.outstanding_amount || 0,
          data.outstanding_currency || data.currency || "USD"
        );
        document.getElementById("summary-next-note").textContent =
          data.next_invoice_note || "Upcoming invoice information will appear here.";
      } catch (err) {
        console.error("Failed to load billing summary", err);
        // Fail silently on summary ‚Äì invoice error banner will handle user-facing errors.
      }
    }

    function renderInvoicesTable(invoices) {
      const tbody = document.getElementById("invoice-tbody");
      const emptyRow = document.getElementById("invoice-empty-row");
      if (!tbody) return;

      tbody.innerHTML = "";
      if (!invoices || invoices.length === 0) {
        if (emptyRow) {
          tbody.appendChild(emptyRow);
        } else {
          const tr = document.createElement("tr");
          tr.innerHTML =
            '<td colspan="6" class="px-4 py-6 text-center text-slate-500 text-xs">No invoices found.</td>';
          tbody.appendChild(tr);
        }
        return;
      }

      invoices.forEach((inv) => {
        const tr = document.createElement("tr");
        const amount = formatCurrency(inv.amount_due ?? inv.total ?? inv.amount || 0, inv.currency || "USD");
        const statusBadge = setBadgeStatus(inv.status);

        const period =
          (inv.period_start ? formatDate(inv.period_start) : "") +
          (inv.period_end ? " ‚Üí " + formatDate(inv.period_end) : "");

        tr.className = "hover:bg-slate-900/60";
        tr.innerHTML = `
          <td class="px-4 py-3 text-[11px] text-slate-300">
            ${formatDate(inv.created_at || inv.created || inv.date)}
          </td>
          <td class="px-4 py-3 text-[11px] text-slate-200">
            ${inv.invoice_number || inv.number || inv.id || "‚Äî"}
          </td>
          <td class="px-4 py-3 text-[11px] text-slate-300">
            ${period || "‚Äì"}
          </td>
          <td class="px-4 py-3 text-[11px] text-right text-slate-50 font-medium">
            ${amount}
          </td>
          <td class="px-4 py-3 text-[11px]">
            <span class="inline-flex items-center rounded-full px-2.5 py-0.5 ${statusBadge.classes}">
              <span class="w-1 h-1 rounded-full bg-current mr-1.5"></span>
              ${statusBadge.label}
            </span>
          </td>
          <td class="px-4 py-3 text-[11px] text-right">
            <button
              class="inline-flex items-center rounded-lg border border-slate-700 px-2 py-1 text-[11px] text-slate-200 hover:bg-slate-900/80"
              data-invoice-id="${inv.id || inv.invoice_id}"
            >
              ‚¨á PDF
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      // Wire download buttons
      tbody.querySelectorAll("button[data-invoice-id]").forEach((btn) => {
        btn.addEventListener("click", async (e) => {
          const id = e.currentTarget.getAttribute("data-invoice-id");
          if (!id) return;
          await downloadSingleInvoice(id);
        });
      });
    }

    async function loadInvoices() {
      const errorEl = document.getElementById("invoice-error");
      if (errorEl) errorEl.classList.add("hidden");

      try {
        const data = await fetchJson(API_BASE + "/invoices");
        // Expecting array: data.invoices or data
        const invoices = Array.isArray(data) ? data : data.invoices || [];
        renderInvoicesTable(invoices);
      } catch (err) {
        console.error("Failed to load invoices", err);
        if (err.status === 401 || err.status === 403 || err.message === "Missing token") {
          const errorEl = document.getElementById("invoice-error");
          if (errorEl) {
            errorEl.textContent =
              "Unauthorized. Please ensure your partner JWT is valid and saved above.";
            errorEl.classList.remove("hidden");
          }
        } else {
          const errorEl = document.getElementById("invoice-error");
          if (errorEl) {
            errorEl.textContent =
              "Unable to load invoices at the moment. Please try again later.";
            errorEl.classList.remove("hidden");
          }
        }
      }
    }

    async function downloadAllInvoicesZip() {
      const token = getToken();
      if (!token) {
        alert("Please paste and save a valid partner JWT token first.");
        return;
      }
      try {
        const res = await fetch(API_BASE + "/download-all", {
          headers: {
            "Authorization": "Bearer " + token,
          },
        });
        if (!res.ok) {
          throw new Error("Download failed: " + res.status);
        }
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "alphine-billing-invoices.zip";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } catch (err) {
        console.error("Failed to download all invoices", err);
        alert("Unable to download invoices ZIP. Please try again later.");
      }
    }

    async function downloadSingleInvoice(id) {
      const token = getToken();
      if (!token) {
        alert("Please paste and save a valid partner JWT token first.");
        return;
      }
      if (!id) return;

      try {
        const res = await fetch(API_BASE + "/invoice/" + encodeURIComponent(id), {
          headers: {
            "Authorization": "Bearer " + token,
          },
        });
        if (!res.ok) {
          throw new Error("Download failed: " + res.status);
        }
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `invoice-${id}.pdf`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } catch (err) {
        console.error("Failed to download invoice", err);
        alert("Unable to download this invoice. Please try again later.");
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      // Footer year
      const yearEl = document.getElementById("footer-year");
      if (yearEl) yearEl.textContent = new Date().getFullYear();

      // Token state
      updateTokenUiState();

      document.getElementById("save-token-btn")?.addEventListener("click", () => {
        const input = document.getElementById("token-input");
        if (!input) return;
        const value = input.value.trim();
        if (!value) {
          alert("Please paste a non-empty token.");
          return;
        }
        setToken(value);
        alert("Token saved in this browser.");
        // After saving, load data immediately
        loadSummary();
        loadInvoices();
      });

      document.getElementById("refresh-billing-btn")?.addEventListener("click", () => {
        loadSummary();
        loadInvoices();
      });

      document.getElementById("download-all-btn")?.addEventListener("click", () => {
        downloadAllInvoicesZip();
      });

      // Auto-load if token already present
      if (getToken()) {
        loadSummary();
        loadInvoices();
      } else {
        const statusEl = document.getElementById("token-status");
        if (statusEl) statusEl.classList.remove("hidden");
      }

      // HTMX: inject Authorization header on any HTMX request (future use)
      document.body.addEventListener("htmx:configRequest", (event) => {
        const token = getToken();
        if (token) {
          event.detail.headers["Authorization"] = "Bearer " + token;
        }
      });
    });
  </script>
</body>
</html>
