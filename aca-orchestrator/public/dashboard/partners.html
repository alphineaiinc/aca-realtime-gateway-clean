<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Partner Dashboard â€“ Alphine AI</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
:root {
  --gold: #ffd700;
  --bg: #0d1117;
  --card-bg: rgba(255,255,255,0.07);
  --text-light: #d1d5db;
  --accent: #ffea5c;
}

body {
  background: var(--bg);
  color: var(--text-light);
  font-family: 'Inter', sans-serif;
  margin: 0;
  padding: 2rem;
  display: flex;
  flex-direction: column;
  align-items: center;
}

h1 {
  color: var(--gold);
  margin-bottom: 1rem;
  text-shadow: 0 0 12px rgba(255,215,0,0.5);
  letter-spacing: 0.5px;
}

.dashboard-container {
  width: 100%;
  max-width: 900px;
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

.card {
  background: var(--card-bg);
  border-radius: 1rem;
  padding: 1.5rem;
  box-shadow: 0 4px 20px rgba(0,0,0,0.4);
  backdrop-filter: blur(8px);
}

.card h3 {
  margin-top: 0;
  color: var(--gold);
  font-weight: 600;
}

.profile-info {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 0.75rem;
  font-size: 0.95rem;
}

.profile-info div {
  padding: 0.5rem;
  background: rgba(255,255,255,0.05);
  border-radius: 0.5rem;
}

button {
  background: var(--gold);
  color: #000;
  border: none;
  border-radius: 0.5rem;
  padding: 0.6rem 1.2rem;
  font-weight: 600;
  cursor: pointer;
  margin-top: 0.5rem;
  transition: 0.2s;
}
button:hover { background: var(--accent); }

.referrals-list {
  margin-top: 1rem;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.referral-item {
  padding: 0.6rem 0.8rem;
  border-radius: 0.4rem;
  background: rgba(255,255,255,0.05);
  font-size: 0.9rem;
}

.empty-state {
  font-style: italic;
  color: #aaa;
}

canvas {
  width: 100%;
  max-width: 400px;
  margin-top: 1rem;
}
</style>
</head>

<body>
<h1>Partner Dashboard</h1>

<div class="dashboard-container">

  <div class="card" id="profile">
    <h3>Profile</h3>
    <div class="profile-info"><i>Loading profile...</i></div>
    <button id="logoutBtn" style="display:none;">Logout</button>
  </div>

  <div class="card">
    <h3>Reward Summary</h3>
    <canvas id="rewardChart"></canvas>
  </div>

  <div class="card" id="referrals">
    <h3>Referrals</h3>
    <div class="referrals-list"><i>Loading referrals...</i></div>
  </div>

</div>

<script>
(async function(){
  let token = localStorage.getItem("partner_token");
  if (!token) {
    token = prompt("Enter your Partner Token:");
    if (token) localStorage.setItem("partner_token", token);
  }
  if (!token) {
    alert("No token entered. Reload and provide your Partner Token to view data.");
    return;
  }

  const headers = { "Authorization": "Bearer " + token };
  document.getElementById("logoutBtn").style.display = "inline-block";
  document.getElementById("logoutBtn").addEventListener("click", () => {
    localStorage.removeItem("partner_token");
    location.reload();
  });

  try {
    // Fetch Partner Profile
    const profileResp = await fetch("/partner/profile", { headers });
    const profile = await profileResp.json();
    if (!profile.ok) throw new Error(profile.error || "Profile fetch failed.");

    const infoHTML = `
      <div><b>Name:</b> ${profile.profile.name}</div>
      <div><b>Email:</b> ${profile.profile.email}</div>
      <div><b>Referral Code:</b> ${profile.profile.referral_code}</div>
      <div><b>Country:</b> ${profile.profile.country}</div>
      <div><b>Status:</b> ${profile.profile.status}</div>
    `;
    document.querySelector("#profile .profile-info").innerHTML = infoHTML;

    // Fetch Reward Summary
    const rewardResp = await fetch("/partner/rewards", { headers });
    const reward = await rewardResp.json();
    const ctx = document.getElementById("rewardChart");
    new Chart(ctx,{
      type:"doughnut",
      data:{
        labels:["Earned","Redeemed"],
        datasets:[{
          data:[reward.summary.earned,reward.summary.redeemed],
          backgroundColor:["#ffd700","#444"],
          borderColor:"#0d1117",
          borderWidth:2
        }]
      },
      options:{
        plugins:{
          legend:{labels:{color:"#fff"}},
          tooltip:{backgroundColor:"#111"}
        }
      }
    });

    // Fetch Referrals
    const refResp = await fetch("/partner/referrals", { headers });
    const ref = await refResp.json();
    const container = document.querySelector(".referrals-list");
    if (ref.referrals.length === 0) {
      container.innerHTML = "<div class='empty-state'>No referrals yet.</div>";
    } else {
      container.innerHTML = ref.referrals.map(r=>`
        <div class="referral-item">
          <b>${r.business_name || "Pending"}</b><br>
          Status: ${r.reward_status}
        </div>
      `).join("");
    }

  } catch (err) {
    console.error("Dashboard load error:", err);
    alert("Unable to load dashboard data: " + err.message);
  }
})();
</script>
</body>
</html>
