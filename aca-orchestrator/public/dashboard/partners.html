<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Partner Dashboard – Alphine AI</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
body{background:#0d1117;color:#fff;font-family:Inter,sans-serif;margin:0;padding:2rem}
h1{color:#ffd700}
.card{background:rgba(255,255,255,0.05);border-radius:1rem;padding:1rem;margin-bottom:1rem;box-shadow:0 0 10px rgba(0,0,0,0.4)}
button{background:#ffd700;border:none;border-radius:.5rem;padding:.5rem 1rem;cursor:pointer;color:#000}
button:hover{background:#fff04f}
</style>
</head>
<body>
<h1>Partner Dashboard</h1>

<div class="card" id="profile">
  <i>Loading partner profile...</i>
</div>

<div class="card">
  <h3>Reward Summary</h3>
  <canvas id="rewardChart" width="400" height="200"></canvas>
</div>

<div class="card" id="referrals">
  <h3>Referrals</h3>
  <i>Loading referrals...</i>
</div>

<script>
(async function(){
  let token = localStorage.getItem("partner_token");
  if (!token) {
    token = prompt("Enter your Partner Token:");
    if (token) localStorage.setItem("partner_token", token);
  }
  if (!token) {
    alert("No token entered. Reload and provide your Partner Token to view data.");
    return;
  }

  const headers = { "Authorization": "Bearer " + token };

  try {
    // Fetch Partner Profile
    const profileResp = await fetch("/partner/profile", { headers });
    const profile = await profileResp.json();
    if (!profile.ok) throw new Error(profile.error || "Profile fetch failed.");

    document.getElementById("profile").innerHTML = `
      <h3>${profile.profile.name}</h3>
      <div>${profile.profile.email}</div>
      <div>Referral Code: <b>${profile.profile.referral_code}</b></div>
      <div>Country: ${profile.profile.country}</div>
      <div>Status: ${profile.profile.status}</div>
    `;

    // Fetch Reward Summary
    const rewardResp = await fetch("/partner/rewards", { headers });
    const reward = await rewardResp.json();
    const ctx = document.getElementById("rewardChart");
    new Chart(ctx,{
      type:"doughnut",
      data:{
        labels:["Earned","Redeemed"],
        datasets:[{data:[reward.summary.earned,reward.summary.redeemed],
                   backgroundColor:["#ffd700","#444"]}]
      }
    });

    // Fetch Referrals
    const refResp = await fetch("/partner/referrals", { headers });
    const ref = await refResp.json();
    document.getElementById("referrals").innerHTML =
      "<h3>Referrals</h3>" +
      (ref.referrals.length
        ? ref.referrals.map(r=>`<div>${r.business_name||'Pending'} — ${r.reward_status}</div>`).join("")
        : "<i>No referrals yet.</i>");

  } catch (err) {
    console.error("Dashboard load error:", err);
    alert("Unable to load dashboard data: " + err.message);
  }
})();
</script>
</body>
</html>
