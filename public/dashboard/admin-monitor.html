<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>ACA Admin Monitor Dashboard ‚Äî Story 4.Final</title>
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
  <style>
    body{background:#0e0e11;color:#f8f9fa;font-family:Inter,Roboto,sans-serif;padding:20px;overflow-x:hidden;}
    h2{text-align:center;font-weight:600;margin-bottom:1.5rem;}
    table{color:#f8f9fa;font-size:.9rem;}
    th{background:#1b1b1f;}
    .status-good{color:#4ade80;font-weight:600;}
    .status-warn{color:#facc15;font-weight:600;}
    .status-bad{color:#fb923c;font-weight:600;}

    /* Banner */
    .banner{
      text-align:center;padding:12px;border-radius:10px;margin-bottom:1rem;
      font-weight:600;font-size:1.1rem;color:#fff;transition:all .4s ease;
      box-shadow:0 0 8px rgba(0,0,0,0.4);
    }
    .banner.ok{
      background:linear-gradient(90deg,#16a34a,#22c55e);
      box-shadow:0 0 12px rgba(34,197,94,.6);
    }
    .banner.warn{
      background:linear-gradient(90deg,#facc15,#f59e0b);
      color:#111;box-shadow:0 0 12px rgba(250,204,21,.5);
    }
    .banner.bad{
      background:linear-gradient(90deg,#ffeb3b,#ff9800);
      color:#111;box-shadow:0 0 14px rgba(255,152,0,.6);
      animation:pulse 1.5s infinite;
    }
    @keyframes pulse{0%,100%{opacity:1;}50%{opacity:.7;}}

    tr.table-danger{background-color:#3c1a0a!important;}
    tr.table-warning{background-color:#332804!important;}

    #tenantPanel{display:none;animation:fadeIn .3s ease;}
    @keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
    #backBtn{
      position:fixed;top:15px;left:15px;z-index:9999;
      background:#333;color:#fff;border:none;border-radius:6px;
      padding:8px 16px;cursor:pointer;font-weight:600;
      box-shadow:0 0 10px rgba(255,255,255,0.2);display:none;
      transition:all .3s ease;
    }
    #backBtn:hover{background:#555;box-shadow:0 0 12px rgba(255,255,255,0.4);}
    #tenantPanel pre{
      background:#111;color:#10b981;padding:10px;border-radius:8px;
      height:260px;overflow-y:auto;
    }
    footer{position:fixed;bottom:10px;right:15px;font-size:.75rem;color:#6b7280;}
  </style>
</head>
<body>
  <button id="backBtn">‚¨Ö Back</button>

  <div class="container" id="adminView">
    <h2>üåê ACA Admin ‚Äî Multi-Tenant Monitor</h2>
    <div id="banner" class="banner ok">Loading overall system status‚Ä¶</div>

    <table class="table table-striped table-hover align-middle">
      <thead>
        <tr>
          <th>Tenant ID</th><th>Active Alerts</th><th>Recoveries</th>
          <th>Last Alert</th><th>Status</th><th>View</th>
        </tr>
      </thead>
      <tbody id="tenantTable"></tbody>
    </table>
    <p class="text-center text-secondary small mt-3">
      Updated at <span id="timestamp">‚Äî</span>
    </p>
  </div>

  <div class="container" id="tenantPanel">
    <div class="tenant-content mt-5">
      <h3 class="text-center text-warning" id="tenantTitle">Tenant Dashboard</h3>
      <div id="tenantBody" class="mt-3 text-center text-secondary">Loading‚Ä¶</div>
    </div>
  </div>

  <footer>ACA Monitor v4.Final ‚Ä¢ Auto-refresh 5 s</footer>

  <script>
    const table=document.getElementById("tenantTable"),
          banner=document.getElementById("banner"),
          tenantPanel=document.getElementById("tenantPanel"),
          tenantBody=document.getElementById("tenantBody"),
          tenantTitle=document.getElementById("tenantTitle"),
          adminView=document.getElementById("adminView"),
          backBtn=document.getElementById("backBtn");

    async function loadAdmin(){
      try{
        const res=await fetch("/monitor/admin");
        if(!res.ok)throw new Error(`HTTP ${res.status}`);
        const data=await res.json();
        table.innerHTML="";
        if(!data.tenants?.length){
          table.innerHTML="<tr><td colspan='6' class='text-center text-secondary'>No tenant data found</td></tr>";
          return;
        }

        let globalStatus="ok",totalAlerts=0;
        data.tenants.forEach(t=>{
          const tr=document.createElement("tr");
          let status="OK";
          if(t.active_alerts>0){
            status=t.active_alerts>2?"Critical":"Warning";
            totalAlerts+=t.active_alerts;
          }
          if(status==="Warning"&&globalStatus==="ok")globalStatus="warn";
          if(status==="Critical")globalStatus="bad";

          if(status==="Critical")tr.classList.add("table-danger");
          else if(status==="Warning")tr.classList.add("table-warning");

          tr.innerHTML=`
            <td>${t.business_id}</td>
            <td>${t.active_alerts}</td>
            <td>${t.recoveries ?? 0}</td>
            <td>${t.last_alert||"‚Äî"}</td>
            <td class="${status==="OK"?"status-good":status==="Warning"?"status-warn":"status-bad"}">${status}</td>
            <td><button class="btn btn-sm btn-outline-info" data-tenant="${t.business_id}">Open</button></td>`;
          table.appendChild(tr);
        });

        // Banner state
        if(globalStatus==="bad"){
          banner.textContent=`üö® Critical issues detected (${totalAlerts} active alerts)`;
          banner.className="banner bad";
        }else if(globalStatus==="warn"){
          banner.textContent=`‚ö†Ô∏è Some tenants have warnings (${totalAlerts} alerts total)`;
          banner.className="banner warn";
        }else{
          banner.textContent="‚úÖ All tenants operational";
          banner.className="banner ok";
        }
        document.getElementById("timestamp").textContent=
          new Date(data.timestamp||Date.now()).toLocaleTimeString();
      }catch(e){
        console.error(e);
        banner.textContent="‚ö†Ô∏è Failed to connect to monitor service";
        banner.className="banner warn";
      }
    }

    async function openTenant(id){
      adminView.style.display="none";
      tenantPanel.style.display="block";
      backBtn.style.display="block";
      tenantTitle.textContent=`Tenant ${id} Dashboard`;
      try{
        const res=await fetch(`/monitor/overview?tenant_id=${id}`);
        const d=await res.json();
        const alerts = (d.latest_alerts || [])
  .map(a => {
    const t = new Date(a.time || a.timestamp || Date.now()).toLocaleString();
    return `[${a.level || a.severity || "info"}] ${a.message || "No message"} ‚Äî ${t}`;
  })
  .join("\n");

const recs = (d.latest_recoveries || [])
  .map(r => {
    const t = new Date(r.timestamp || r.time || Date.now()).toLocaleString();
    return `[${r.status || "info"}] ${r.action || r.issueType || "Recovered"} ‚Äî ${t}`;
  })
  .join("\n");

tenantBody.innerHTML = `
  <div class="row">
    <div class="col-md-6">
      <h5 class="text-danger">Recent Alerts</h5>
      <pre>${alerts || "None"}</pre>
    </div>
    <div class="col-md-6">
      <h5 class="text-success">Recent Recoveries</h5>
      <pre>${recs || "None"}</pre>
    </div>
  </div>`;

      }catch(e){
        tenantBody.innerHTML=`<p class="text-danger">Failed to load tenant data.</p>`;
      }
    }

    backBtn.addEventListener("click",()=>{
      tenantPanel.style.display="none";
      adminView.style.display="block";
      backBtn.style.display="none";
      tenantBody.innerHTML="Loading‚Ä¶";
    });

    table.addEventListener("click",e=>{
      if(e.target.matches("button[data-tenant]")){
        openTenant(e.target.getAttribute("data-tenant"));
      }
    });

    loadAdmin();
    setInterval(loadAdmin,5000);
  </script>
</body>
</html>
