<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ACA Business Health Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />

  <style>
    body {
      background-color: #0e0e11;
      color: #f8f9fa;
      font-family: "Inter", "Roboto", sans-serif;
      padding: 2rem;
    }

    h2 {
      text-align: center;
      font-weight: 600;
      margin-bottom: 1rem;
      color: #f8f9fa;
    }

    .refresh-time {
      text-align: center;
      font-size: 0.9rem;
      color: #adb5bd;
      margin-bottom: 1.5rem;
    }

    .alert-card {
      border-radius: 1rem;
      margin-bottom: 1rem;
      padding: 1rem 1.5rem;
      box-shadow: 0 0 12px rgba(255, 255, 255, 0.1);
      transition: transform 0.2s ease, background-color 0.2s ease;
    }

    .alert-card:hover {
      transform: translateY(-2px);
    }

    .alert-critical { background-color: rgba(220, 53, 69, 0.15); border-left: 6px solid #dc3545; }
    .alert-warning { background-color: rgba(255, 193, 7, 0.15); border-left: 6px solid #ffc107; }
    .alert-info { background-color: rgba(13, 202, 240, 0.15); border-left: 6px solid #0dcaf0; }
    .alert-high { background-color: rgba(255, 102, 102, 0.15); border-left: 6px solid #ff6666; }

    .alert-time {
      font-size: 0.85rem;
      color: #adb5bd;
      margin-bottom: 0.25rem;
    }

    .alert-message {
      font-size: 1rem;
      font-weight: 500;
    }

    .alert-source {
      font-size: 0.85rem;
      color: #9aa0a6;
    }

    footer {
      text-align: center;
      margin-top: 2rem;
      color: #6c757d;
      font-size: 0.85rem;
    }

    .no-alerts {
      text-align: center;
      color: #999;
      margin-top: 2rem;
      font-style: italic;
    }
  </style>
</head>

<body>
  <h2>ACA Business Health Dashboard</h2>
  <div class="refresh-time">Loading latest alerts...</div>

  <div id="alertContainer"></div>

  <footer>Powered by Alphine AI — Automated Call Attender (ACA)</footer>

  <script>
    // ----------------------------------------------------------
    // Utility: Get business_id from query parameter
    // ----------------------------------------------------------
    function getBusinessId() {
      const urlParams = new URLSearchParams(window.location.search);
      return parseInt(urlParams.get("business_id")) || null;
    }

    const alertContainer = document.getElementById("alertContainer");
    const refreshTime = document.querySelector(".refresh-time");

    // ----------------------------------------------------------
    // Load Alerts
    // ----------------------------------------------------------
    async function loadAlerts() {
      const business_id = getBusinessId();
      if (!business_id) {
        alertContainer.innerHTML = `<p class="no-alerts">❌ Missing or invalid business_id parameter in URL.</p>`;
        return;
      }

      try {
        const res = await fetch(`/monitor/business/${business_id}/alerts`);
        const data = await res.json();

        if (!data.ok) {
          alertContainer.innerHTML = `<p class="no-alerts">⚠️ Failed to load alerts: ${data.error}</p>`;
          return;
        }

        const alerts = data.alerts;
        refreshTime.textContent = `Last refreshed: ${new Date().toLocaleTimeString()}`;

        if (!alerts || alerts.length === 0) {
          alertContainer.innerHTML = `<p class="no-alerts">✅ No active alerts for this business.</p>`;
          return;
        }

        alertContainer.innerHTML = alerts
          .reverse()
          .map((a) => {
            const sev = (a.severity || "info").toLowerCase();
            const cls = `alert-card alert-${sev}`;
            return `
              <div class="${cls}">
                <div class="alert-time">${new Date(a.time).toLocaleString()}</div>
                <div class="alert-message">${a.message}</div>
                <div class="alert-source">Source: ${a.component || "system"} | Severity: ${a.severity}</div>
              </div>`;
          })
          .join("");
      } catch (err) {
        console.error("Error loading alerts:", err);
        alertContainer.innerHTML = `<p class="no-alerts">⚠️ Error fetching alerts. Please retry.</p>`;
      }
    }

    // Initial load and auto-refresh every 10 seconds
    loadAlerts();
    setInterval(loadAlerts, 10000);
  </script>
</body>
</html>
